# A-6 

计研三一

孙亚男

2020215223

sunyn20@mails.tsinghua.edu.cn



## 实验要求

实现以下材料中的 Terrain Engine。
1）	材料见附件 TerrainEngine 文件夹。
2）	摄像机坐标系与全局坐标系之间的变换；
3）	海面的波浪效果；
4）	地形的读取、绘制及纹理贴图；
5）	天空和地形的倒影效果。



## 实验原理

该实验需要实现在窗口中的二维图形绘制、纹理贴图和着色。故使用GLFW库创建窗口，使用GLAD管理函数指针，使用GLM库进行矩阵变换，使用SOIL库进行纹理加载。



## 实验步骤

1. 创建窗口
   
   - 参见习题课一 Lecture1.cpp窗口创建相关代码
   
2. 绘制图形
   - 参见习题课一 Lecture2.cpp绘制三角形相关代码
   - 绘制场景分为若干部分
     - 绘制天空盒子，这里需要注意纹理的对齐
       - 还要调整盒子的尺寸，使得太阳不是瘦长的椭圆形
     - 绘制天空盒子的镜像，与天空盒子关于y=0平面对齐
     - 绘制山地，这里需要使用读入的高度图作为绘制点的y坐标
       - 使用SOIL_load_image读入高度图，注意返回的数组是行优先
       - 绘制山地时需要注意将一部分山地平移到水面，即y=0平面以下，并将这部分图像在片段着色器中丢弃
       - 为山地添加细节
         - 细节部分需要重复贴图以达到更真实的效果
     - 绘制山地的镜像，与山地关于y=0平面对齐
     - 绘制海面，在y=0平面
       - 绘制海面时要注意为了营造海水波动的效果，需要为纹理加入随时间变化的扰动
       - 海面贴图要设置一定的透明度，为了能看到水面下天空和山地的倒影
   
4. 图形纹理贴图

   - 贴图部分参见习题课四 Lecture6_2.cpp贴图相关代码
     - 设置uniform纹理变量用于从主程序中传入纹理
     - 此外设置多个uniform变量用来向顶点着色器中传入绘制点的坐标



## 实验效果

具体实验效果参见录屏，下图为录屏截图：

![1607428792956](C:/Users/80592/AppData/Roaming/Typora/typora-user-images/1607428792956.png)



![1607428818243](C:/Users/80592/AppData/Roaming/Typora/typora-user-images/1607428818243.png)

![1607428840709](C:/Users/80592/AppData/Roaming/Typora/typora-user-images/1607428840709.png)



![1607428868244](C:/Users/80592/AppData/Roaming/Typora/typora-user-images/1607428868244.png)



可以看出，海面上有波浪，地形一部分在水面上一部分沉入水底，放大也较为真实，天空和地形在水面下有倒影。



## 实验环境

Visual Studio 2019

GLFW库 3.3.2

GLAD库

GLM库 0.9.6.3

SOIL库



## 实验遇到的问题或注意的地方

1. 使用贴图时要注意坐标的计算。
2. 细节贴图时要多重复几次才会更真实。
3. 绘制海面上的波浪时，在顶点着色器中对当前点的坐标进行了多余的判断，而导致同一帧中的不同点有的进入if分支，有的进入else分支，得到的赋值混乱。后简化为同一处理方式，问题解决。
4. 在处理地形高度坐标时采用了四种方法
   1. 试图新建一个`256*256*5`大小的vertices数组来存地形数据，但内存不支持，**失败**。
   2. 使用一个`6*6*5`大小的vertices数组来存一个地形正方形，通过不断修改数组数据来绘制整个地形，由于每次都要更新VBO，程序负担太大，**失败**。
   3. 使用一个`6*6*5`大小的vertices数组来存一个地形正方形，通过glm变换矩阵绘制多个正方形，程序负担太大，**失败**。
   4. 使用一个`6*6*5`大小的vertices数组来存一个初始地形正方形，通过uniform变量将当前绘制正方形的xz轴编号传入，将四个顶点的y值传入，在顶点着色器中对坐标进行变换，**成功**。
5. 绘制图像时要注意深度检测，若开启，则需要合理选择绘制顺序。
6. 结果中出现背景色的三角形，是perspective矩阵参数设置过小，天空盒子放大后参数不匹配导致，修改参数后问题解决。
7. 读取高度图时注意行优先还是列优先。